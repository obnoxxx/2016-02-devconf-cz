==== The Idea... ====

+<1->{
<[block]{Failover SMB clusters...}
Around 2006, it was quite customary to run Samba file servers in active-passive
failover clusters.
[block]>
}

+<2->{
<[block]{Clustered file systems...}
At that time, quite a few distributed/clustered file systems
were available: gfs2, gpfs (IBM), GlusterFS, lustre, ocfs2, ...
[block]>
}

+<3->{
<[block]{New Idea...}
Can we create '''all-active''' SMB clusters on top of that with Samba?
[block]>
}


==== from 2007 : CTDB - clustered Samba ====


<[block]{Samba+CTDB: pioneer in scale-out SMB}
* 2006: prototypes
* 2007: CTDB first usable version (with patched Samba)
* 2008: Samba 3.2 first experimental support
* 2009: Samba 3.3 official support
[block]>


==== Clustered SMB - Challenges ====

* SMB-clients not aware\! (Windows...) \\ %
==> All nodes must appear as '''one''' SMB server!
* Nodes must share certain persistent data.
* Daemons must talk to each other cross-node. \\ %
==> How do Samba daemons talk to each other on one node?


==== Samba Daemons ====

<[center]
<<<samba-daemons-vfs-p1.png, width=.8\textwidth>>>
[center]>

==== Samba - VFS ====

<[block]{Samba NTFS semantics - open files}
* share modes (whole file access block)
* mandatory locks (file range access block)
* oplocks/leases (client-side caching, break/revoke)
[block]>


==== Samba Daemons ====

<[center]
<<<samba-daemons-vfs-p1.png, width=.8\textwidth>>>
[center]>

==== Samba Daemons ====

<[center]
<<<samba-daemons-vfs-p2.png, width=.8\textwidth>>>
[center]>

==== Samba Daemons ====

<[center]
<<<samba-daemons-vfs-p3.png, width=.8\textwidth>>>
[center]>

==== Samba Daemons ====

<[center]
<<<samba-daemons-vfs-p4.png, width=.8\textwidth>>>
[center]>


==== smbd : local IPC ====

<[block]{messaging}
* unix domain socket based
* historical: signals
[block]>

<[block]{TDB}
* 'trivial' data base
* records: key-value
* concurrent access with record locks
* memory mapped
* ==> data store of the VFS layer
[block]>

==== CTDB... ====

<[block]{extends the above IPC mechanisms across nodes}
* messages across nodes
* '''very special''' clustered TDB implementation \\ %
  (we may lose certain data...)
[block]>

<[block]{additionally}
* also supports persistent DBs (secrets, registry, ...)
* simple cluster service and IP management software (optional)
[block]>



%%%==== Samba layers ====
%%%
%%%<[center]
%%%<<<samba-layers.png, width=.8\textwidth>>>
%%%[center]>


==== ctdb design - daemons ====

<[center]
<<<ctdb-design-daemons.png, width=\textwidth>>>
[center]>


==== ctdb layout - network ====

<[center]
<<<design-ctdb-three-nodes.png, width=.95\textwidth>>>
[center]>


